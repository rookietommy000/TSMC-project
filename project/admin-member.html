<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>後台</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/all.min.css">
  <link rel="stylesheet" href="css/sweetalert2.min.css">
</head>

<body>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
    <a href="#" onclick="openTab(event, 'Home')">首頁</a>
    <a href="admin-member.html" onclick="openTab(event, 'member')"><i class="fa-solid fa-user"></i>&nbsp;會員管理</a>
    <a href="#" class="dropdown-toggle-split nav-link dropdown-toggle tab" data-bs-toggle="dropdown"
      aria-expanded="false">
      <i class="fa-brands fa-pagelines"></i>&nbsp;商品
    </a>
    <ul class="dropdown-menu">
      <li><a href="admin-product.html" onclick="openTab(event, 'product')" class="text-dark">商品管理</a></li>
      <li><a href="admin-product-type.html" onclick="openTab(event, 'product-type')" class="text-dark">類別總覽</a></li>
    </ul>
    <a href="admin-news.html" onclick="openTab(event, 'news')"><i class="fa-solid fa-rss"></i>&nbsp;消息管理</a>
    <a href="#" onclick="openTab(event, 'cart')"><i class="fa-solid fa-chalkboard"></i>&nbsp;訂單管理</a>
    <a class="nav-link disabled" aria-disabled="true">待定</a>
  </div>
  
  <div id="main">
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; 後臺管理</span>
    <div class="col text-end">
      <span class="text-dark h3" id="user_message"></span>
      <button type="button" id="loginoutButton" class="btn btn-outline-danger">登出</button>
    </div>
    <div class="container-fluid">
      <div class="container pt-5">
        <table class="table table-bordered table-hover table-sm border-success table-rwd">
          <caption class="text-end">會員列表</caption>
          <thead class="table-dark">
            <tr>
              <th>編號</th>
              <th>帳號</th>
              <th>Email</th>
              <th>停權</th>
              <th>註冊時間</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="mydata">
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#updateModal">更新</button>
                <button class="btn btn-danger">刪除</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
  
      <div class="container">
        <nav aria-label="Page navigation example">
          <ul class="pagination justify-content-center" id="pageList">
            <li class="page-item"><a class="page-link" href="#" onclick="drawTable(0)">1</a></li>
          </ul>
        </nav>
      </div>
  
      <!-- updateModal -->
      <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header text-bg-success">
              <h1 class="modal-title fs-3 fw-900" id="exampleModalLabel">會員更新</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="updateModal_username" class="form-label">帳號</label>
                <input type="text" class="form-control" disabled id="updateModal_username" name="updateModal_username">
              </div>
              <div class="mb-3">
                <label for="updateModal_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="updateModal_email" name="updateModal_email">
              </div>
              <div class="mb-3">
                <label for="updateModal_state" class="form-label">狀態</label>
                <input type="number" class="form-control" min="0" max="1" id="updateModal_state"
                  oninput="checkStateInput(this)" name="updateModal_state">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="updateModal_updata_btn">確認</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  

  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>
  <script src="js/admin/login.js"></script>


  <script>
    function openNav() {
      document.getElementById("mySidenav").style.width = "250px";
      document.getElementById("main").style.marginLeft = "250px";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
      document.getElementById("main").style.marginLeft = "0";
    }
    // 限定輸入0或1
    function checkStateInput(input) {
      if (input.value !== '0' && input.value !== '1') {
        input.value = '';
        Swal.fire({
          title: "輸入錯誤",
          text: "請輸入 0 或 1",
          icon: "error",
          showClass: {
            popup: `
                      animate__animated
                      animate__fadeInUp
                      animate__faster
                    `
          },
          hideClass: {
            popup: `
                      animate__animated
                      animate__fadeOutDown
                      animate__faster
                    `
          }
        });
      }
    }

    var u_id; //for update
    var newData = [];
    $(function () {
      //讀取會員資料
      $.ajax({
        type: "GET",
        url: "api/manager-control/member_read-api.php",
        async: false,
        dataType: "json",
        success: showdata,
        error: function () {
          alert("error-member-Read-api.php");
        }
      });

      //#update_btn 更新按鈕監聽
      // $("#mydata #update_btn").click(function () {
      $("body").on("click", "#mydata #update_btn", function () {
        console.log($(this).data("id") + $(this).data("email") + $(this).data("username") + $(this).data("state"));
        u_id = $(this).data("id");
        $("#updateModal_username").val($(this).data("username"));
        $("#updateModal_email").val($(this).data("email"));
        $("#updateModal_state").val($(this).data("state"));
      });



      //delete_btn 刪除按鈕監聽
      // $("#mydata #delete_btn").click(function () {
      $("body").on("click", "#mydata #delete_btn", function () {
        Swal.fire({
          title: "確定要刪除?",
          text: "刪除後無法復原!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "確定!",
          cancelButtonText: "取消",
        }).then((result) => {
          if (result.isConfirmed) {
            console.log($(this).data("id"));
            // 傳遞刪除資料至後端api {"ID":"XX"}
            var dataJSON = {};
            dataJSON["ID"] = $(this).data("id");
            console.log(JSON.stringify(dataJSON));

            $.ajax({
              type: "POST",
              url: "api/manager-control/member_delete-api.php",
              data: JSON.stringify(dataJSON),
              dataType: "json",
              success: showdata_delete,
              error: function () {
                alert("error-member_delete-api.php");
              }
            });
          }
        });
      });


      //#updateModal_updata_btn 監聽
      $("#updateModal_updata_btn").click(function () {
        //傳遞更新資料至後端api {"ID":"XX", "Email":"XXXXX"}
        var dataJSON = {};
        dataJSON["ID"] = u_id;
        dataJSON["Email"] = $("#updateModal_email").val();
        dataJSON["State"] = $("#updateModal_state").val();
        console.log(JSON.stringify(dataJSON));

        $.ajax({
          type: "POST",
          url: "api/manager-control/member_update_api.php",
          data: JSON.stringify(dataJSON),
          dataType: "json",
          success: showdata_update,
          error: function () {
            alert("error-member-Update_api.php");
          }
        });
      });
    });
    function showdata(data) {
      //整理資料儲存為二維陣列
      data.data.forEach(function (item, key) {
        console.log(key);
        if (key % 6 == 0) {
          newData.push([]);
        }
        var page = parseInt(key / 6);
        newData[page].push(item);

      });
      drawTable(0);
      console.log(newData);

      //產生頁碼
      $("#pageList").empty();
      newData.forEach(function (item, key) {
        var thisPage = key + 1;
        var strHTML = '<li class="page-item"><a class="page-link" href="#" onclick="drawTable(' + key + ')">' + thisPage + '</a></li>';
        $("#pageList").append(strHTML);
      });
    }

    function drawTable(page) {
      $("#mydata").empty();
      newData[page].forEach(function (item) {
        var stateText;
        var stateClass;
        switch (item.State) {
          case '0':
            stateText = '停權';
            stateClass = 'stop';
            break;
          case '1':
            stateText = '正常';
            break;
          default:
            stateText = '未知狀態';
            break;
        }

        var strHTML = '<tr><td>' + item.ID + '</td><td>' +
          item.Username + '</td><td>' +
          item.Email + '</td><td>' +
          stateText + '</td><td>' +
          item.Creat_time + '</td><td><button class="btn btn-success me-2" data-id="' +
          item.ID + '" data-email="' +
          item.Email + '"  data-state="' +
          item.State + '" data-username="' +
          item.Username + '" id="update_btn"  data-bs-toggle="modal" data-bs-target="#updateModal">更新</button><button class="btn btn-danger" id="delete_btn" data-id="' + item.ID + '">刪除</button></td></tr>';

        $("#mydata").append(strHTML);
      });
    }


    function showdata_update(data) {
      console.log(data);
      if (data.state) {
        Swal.fire({
          position: "center",
          icon: "success",
          title: "成功儲存！",
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          // 關閉模態對話框
          $("#updateModal").modal("hide");
          location.replace(login.html);
        });
      } else {
        alert(data.message);
      }
    }


    function showdata_delete(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.message);
      }
    }
  </script>

</body>

</html>
<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>後台</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/all.min.css">
  <link rel="stylesheet" href="css/sweetalert2.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
</head>

<body>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
    <a href="#" onclick="openTab(event, 'Home')">首頁</a>
    <a href="admin-member.html" onclick="openTab(event, 'member')"><i class="fa-solid fa-user"></i>&nbsp;會員管理</a>
    <a href="#" class="dropdown-toggle-split nav-link dropdown-toggle tab" data-bs-toggle="dropdown"
      aria-expanded="false">
      <i class="fa-brands fa-pagelines"></i>&nbsp;商品
    </a>
    <ul class="dropdown-menu">
      <li><a href="admin-product.html" onclick="openTab(event, 'product')" class="text-dark">商品管理</a></li>
      <li><a href="admin-product-type.html" onclick="openTab(event, 'product-type')" class="text-dark">類別總覽</a></li>
    </ul>
    <a href="admin-news.html" onclick="openTab(event, 'news')"><i class="fa-solid fa-rss"></i>&nbsp;消息管理</a>
    <a href="#" onclick="openTab(event, 'cart')"><i class="fa-solid fa-chalkboard"></i>&nbsp;訂單管理</a>
    <a class="nav-link disabled" aria-disabled="true">待定</a>
  </div>

  <div id="main">
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; 後臺管理</span>
    <div class="col text-end">
      <span class="text-dark h3" id="user_message"></span>
      <button type="button" id="loginoutButton" class="btn btn-outline-danger">登出</button>
    </div>
    <div class="container-fluid">
      <div class="container">
        <div class="text-end">
          <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addNewsModal">新增</button>
        </div>
        <table class="table table-bordered table-hover table-sm border-success table-rwd">
          <caption class="text-end">消息列表</caption>
          <thead class="table-dark">
            <tr>
              <th class="text-center" width="10%">編號</th>
              <th class="text-center" width="10%">大標</th>
              <th class="text-center" width="10%">標題</th>
              <th class="text-center">文章</th>
              <th class="text-center" width="20%">建立時間</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="mynews">
            <tr>
              <td class="py-4">1</td>
              <td class="py-4"></td>
              <td class="py-4">
              </td>
              <td class="py-4">
              </td>
              <td class="text-center py-4">
                <div class="d-flex align-content-center justify-content-center">
                  <button class="btn btn-success me-2" data-bs-toggle="modal"
                    data-bs-target="#updatenewsModal">更新</button>
                  <button class="btn btn-danger">刪除</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="container">
        <nav aria-label="Page navigation example">
          <ul class="pagination justify-content-center" id="pageList">
            <li class="page-item"><a class="page-link" href="#" onclick="drawTable(0)">1</a></li>
          </ul>
        </nav>
      </div>

      <!-- Addmodal -->
      <div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addModalLabel">新增消息</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 form-floating">
                <input type="text" class="form-control" placeholder="" id="name" name="name">
                <label for="name">大標</label>
                <div class="valid-feedback">字數符合規定</div>
                <div class="invalid-feedback">字數不符合規定</div>
              </div>
              <div class="mb-3 form-floating">
                <input type="text" class="form-control" placeholder="" id="heading" name="heading">
                <label for="heading">標題</label>
                <div class="valid-feedback">數字正確(1~100)</div>
                <div class="invalid-feedback">數字不正確</div>
              </div>
              <div class="mb-3">
                <div class="form-floating">
                  <textarea class="form-control" placeholder="Leave a comment here" id="content"
                    style="height: 100px"></textarea>
                  <label for="content">文章</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              <button type="button" class="btn btn-info" id="ok_button">確認</button>
            </div>
          </div>
        </div>
      </div>

      <!-- UPdatenewsModal -->
      <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="updateModalLabel">更新消息</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 form-floating">
                <input type="text" class="form-control" placeholder="" id="ntitle" name="title" list="myoption">
                <label for="updateTitle">Title</label>
                <div class="valid-feedback">字數符合規定</div>
                <div class="invalid-feedback">字數不符合規定</div>
              </div>
              <div class="mb-3">
                <label for="updateHeading" class="form-label">Heading</label>
                <input type="text" class="form-control" id="nheading" name="nheading">
                <div class="valid-feedback">數字正確(1~100)</div>
                <div class="invalid-feedback">數字不正確</div>
              </div>
              <div class="mb-3">
                <div class="form-floating">
                  <textarea class="form-control" placeholder="Leave a comment here" id="ncontent"
                    style="height: 100px"></textarea>
                  <label for="content">Content</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
              <button type="button" class="btn btn-info" id="updatenews_button">更新</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>



  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/sweetalert2.all.min.js"></script>
  <script src="js/admin/login.js"></script>
  

  <script>
    // read
    function openNav() {
      document.getElementById("mySidenav").style.width = "250px";
      document.getElementById("main").style.marginLeft = "250px";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
      document.getElementById("main").style.marginLeft = "0";
    }

    var newData = [];
    $(function () {
      $.ajax({
        type: "GET",
        url: "api/news/news-read-api.php",
        dataType: "json",
        success: shownewsdata,
        error: function () {
          alert("error-api/news/news-read-api.php");
        }
      });
    });

    function shownewsdata(data) {
      console.log(data);
      data.data.forEach(function (item, key) {
        console.log(key);
        if (key % 5 == 0) {
          newData.push([]);
        }
        var page = parseInt(key / 5);
        newData[page].push(item);

      });
      drawTable(0);
      console.log(newData);

      //產生頁碼
      $("#pageList").empty();
      newData.forEach(function (item, key) {
        var thisPage = key + 1;
        var strHTML = '<li class="page-item"><a class="page-link" href="#" onclick="drawTable(' + key + ')">' + thisPage + '</a></li>';
        $("#pageList").append(strHTML);
      });
    }

    function drawTable(page) {
      $("#mynews").empty();
      newData[page].forEach(function (item) {

        var strHTMLnews = '';
          console.log(item.ID);
          strHTMLnews += '<tr><td class="py-4">'
            + item.ID + '</td><td class="py-4">'
            + item.Title + '</td><td class="py-4">'
            + item.Heading + '</td><td class="py-4">'
            + item.content + '</td><td class="text-center py-4">'
            + item.Created_at + '</td><td class="text-center py-4"><div class="d-flex align-content-center justify-content-center"><button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="' + item.ID +
            '" data-aname="' + item.Title +
            '" data-aheading="' + item.Heading +
            '"  data-acontent="' + item.content +
            '"  id="updatanews">更新</button><button class="btn btn-danger" data-id="' + item.ID + '"  id="delete_btn">刪除</button></div></td></tr>';
        $("#mynews").append(strHTMLnews);
      });
    }

    // create
    var flag_name = false;
    var flag_heading = false;
    var flag_content = false;
    var u_id;
    // 監聽_及時監聽 #name
    $(function () {
      $("#name").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 0 && $(this).val().length < 10) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_name = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_name = false;
        }
      });

      $("#heading").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 0 && $(this).val().length < 10) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_heading = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_heading = false;
        }
      });

      $("#content").bind("input propertychange", function () {
        console.log($(this).val().length);
        if ($(this).val().length > 50 && $(this).val().length < 1000) {
          // 字數符合
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_content = true;
        } else {
          // 字數不符合
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_content = false;
        }
      });

      // 按鈕監聽
      $("#ok_button").click(function () {
        if (flag_name && flag_heading && flag_content) {
          console.log($("#name").val());

          var dataJSON = {};
          dataJSON["Title"] = $("#name").val();
          dataJSON["Heading"] = $("#heading").val();
          dataJSON["content"] = $("#content").val();
          console.log(JSON.stringify(dataJSON));
          //傳遞至後端
          $.ajax({
            type: "POST",
            url: "api/news/news-create-api.php",
            data: JSON.stringify(dataJSON),
            dataType: "json",
            success: showdatanews02,
            error: function () {
              alert("error-api/news/news-create-api.php");
            }
          });
        } else {
          alert("欄位有誤, 請修正!");
        }
      });
    });

    function showdatanews02(data) {
      if (data.state) {
        $("#addNewsModal").modal("hide");
        location.href = "admin-news.html";
        alert(data.message);
      } else {
        alert(data.message);
      }
    }

    // 監聽#updata_btn

    $("#mynews").on("click", "#updatanews", function () {
      console.log("updata_btn_ok");
      console.log($(this).data("id"));
      console.log($(this).data("aname"));
      console.log($(this).data("aheading"));
      console.log($(this).data("acontent"));

      u_id = $(this).data("id");
      $("#ntitle").val($(this).data("aname"));
      $("#nheading").val($(this).data("aheading"));
      $("#ncontent").val($(this).data("acontent"));
    });

    // 監聽 #modal_update_btn
    $("#updatenews_button").click(function () {
      var dataJSON = {};
      dataJSON["ID"] = u_id;
      dataJSON["Title"] = $("#ntitle").val();
      dataJSON["Heading"] = $("#nheading").val();
      dataJSON["content"] = $("#ncontent").val();
      console.log(u_id);
      console.log(JSON.stringify(dataJSON));
      console.log($("#mytype #updatanews").length);

      // 傳遞更新參數至後端api
      $.ajax({
        type: "POST",
        url: "api/news/news-update-api.php",
        data: JSON.stringify(dataJSON),
        dataType: "json",
        success: showdatatype_update,
        error: function () {
          alert("error-api/product-type/product-type_update-api.php");
        }
      });
    });

    function showdatatype_update(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.href = "admin-news.html"
      } else {
        alert(data.message);
      }
    }


    //監聽#delete_btn
    $("#mynews").on("click", "#delete_btn", function () {
      if (confirm("確認刪除此筆資料嗎?")) {
        console.log($(this).data("id"));

        //產生json格式的參數
        var dataJSON = {};
        dataJSON["ID"] = $(this).data("id");
        console.log(JSON.stringify(dataJSON));

        //傳遞參數至後端api執行刪除功能
        $.ajax({
          type: "POST",
          url: "api/news/news-delete-api.php",
          data: JSON.stringify(dataJSON),
          dataType: "json",
          success: showdata_delete,
          error: function () {
            alert("error-api/product-type/product-type_delete-api.php");
          }
        });
      }
    });


    function showdata_delete(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.href = "admin-news.html";
      } else {
        alert(data.message);
      }
    }
  </script>

</body>

</html>